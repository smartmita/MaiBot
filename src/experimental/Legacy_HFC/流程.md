graph TD
    A[接收群消息] --> B{消息预处理与过滤};
    B --> C[计算初步兴趣度];
    C --> D[获取/创建 SubHeartflow (SHF)];
    D --> E[SHF: 更新群聊兴趣等级 InterestChatting];

    subgraph SHF 状态管理与转换
        E --> F{SHF 当前状态?};
        F -- ABSENT --> G_ABSENT[后台任务: SHF Manager 评估];
        G_ABSENT -- 兴趣低/LLM决策不聊 --> F;
        G_ABSENT -- LLM决策随便聊聊 & 限额未满 --> H_CHAT[SHF: 转换为 CHAT 状态];
        G_ABSENT -- 兴趣高 & LLM决策专注 & 限额未满 --> I_FOCUSED[SHF: 转换为 FOCUSED 状态];

        F -- CHAT --> G_CHAT[后台任务: SHF Manager 评估];
        G_CHAT -- 兴趣高 & LLM决策专注 & 限额未满 --> I_FOCUSED;
        G_CHAT -- 长时间不活跃 --> J_ABSENT[SHF: 转换为 ABSENT 状态];
        G_CHAT -- 保持CHAT --> K_NORMAL_CHAT[SHF: 激活/运行 NormalChat];

        F -- FOCUSED --> G_FOCUSED[后台任务: SHF Manager 评估];
        G_FOCUSED -- HFC内部决策退出/不回复超时 --> L_SWITCH_OUT_FOCUS{SHF: 退出专注};
        L_SWITCH_OUT_FOCUS -- 私聊或概率 --> J_ABSENT;
        L_SWITCH_OUT_FOCUS -- 群聊概率 & CHAT限额未满 --> H_CHAT;
        G_FOCUSED -- 保持FOCUSED --> M_HFC_CHAT[SHF: 激活/运行 HeartFChatting];
    end

    K_NORMAL_CHAT --> K1[NormalChat: 处理兴趣消息];
    K1 --> K2{计算回复意愿与概率};
    K2 -- 概率不足/不愿回复 --> E;
    K2 -- 决定回复 --> K3[NormalChatGenerator: LLM生成回复];
    K3 --> K4[HeartFCSender: 发送消息];
    K4 --> E;

    M_HFC_CHAT --> M1[HeartFChatting: 开始循环];
    M1 --> M2[观察: ChattingObservation.observe()];
    M2 --> M3[思考: SubMind.do_thinking_before_reply()];
    M3 --> M3a{思考期间有新消息?};
    M3a -- 是,且满足重规划条件 --> M2;
    M3a -- 否 --> M4[规划: Planner (LLM决策动作)];
    M4 --> M5{动作类型?};
    M5 -- no_reply --> M6[等待新消息/超时];
    M6 --> M7{连续不回复/等待超时?};
    M7 -- 是 --> L_SWITCH_OUT_FOCUS;
    M7 -- 否 --> M1;
    M5 -- exit_focus_mode --> L_SWITCH_OUT_FOCUS;
    M5 -- emoji_reply --> M8[发送表情];
    M8 --> M1;
    M5 -- text_reply --> M9[回复: Replier (LLM生成文本)];
    M9 --> M10[发送: Sender 发送文本/表情/@/戳];
    M10 --> M1;

    H_CHAT --> K_NORMAL_CHAT;
    I_FOCUSED --> M_HFC_CHAT;
    J_ABSENT --> E;

    %% Styling
    classDef default fill:#f9f,stroke:#333,stroke-width:2px;
    classDef state fill:#lightgrey,stroke:#333,stroke-width:2px;
    classDef process fill:#lightblue,stroke:#333,stroke-width:2px;
    classDef decision fill:#lightgreen,stroke:#333,stroke-width:2px;
    classDef io fill:#orange,stroke:#333,stroke-width:2px;

    class A,K4,M8,M10 io;
    class B,C,D,E,K1,K3,M1,M2,M3,M6,M9 process;
    class F,K2,M3a,M5,M7,L_SWITCH_OUT_FOCUS decision;
    class G_ABSENT,G_CHAT,G_FOCUSED,H_CHAT,I_FOCUSED,J_ABSENT,K_NORMAL_CHAT,M_HFC_CHAT state;
